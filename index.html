<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Infracciones - GAMO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            -webkit-font-smoothing: antialiased; 
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ticket-container {
            max-width: 1000px;
            margin: 1.5rem auto;
            background: white;
            padding: 2.5rem;
            border-radius: 32px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.05);
            border-top: 12px solid #b91c1c;
        }

        .input-field {
            @apply w-full bg-gray-50 border border-gray-200 rounded-2xl px-4 py-3 text-sm focus:ring-4 focus:ring-red-50 focus:border-red-600 focus:bg-white outline-none transition-all duration-300;
        }

        .label-style {
            @apply block text-[11px] font-bold uppercase text-gray-500 mb-1.5 ml-1 tracking-wider;
        }

        #sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 10px;
            font-weight: 800;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .stat-card {
            @apply bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col items-center justify-center text-center transition-transform hover:scale-105;
        }

        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="p-4 md:p-10">

    <!-- Indicador de Estado -->
    <div id="sync-indicator" class="bg-amber-50 text-amber-600 border border-amber-200 uppercase">
        <span class="w-2 h-2 bg-amber-500 rounded-full animate-ping"></span>
        Sincronizando...
    </div>

    <div class="ticket-container no-print">
        <!-- Encabezado Institucional -->
        <div class="flex flex-col md:row justify-between items-start md:items-center mb-10 pb-8 border-b border-gray-100 gap-6">
            <div class="flex items-center gap-5">
                <div class="bg-red-700 text-white w-16 h-16 flex items-center justify-center rounded-2xl font-black text-4xl shadow-2xl shadow-red-200 rotate-3 hover:rotate-0 transition-transform">O</div>
                <div>
                    <h2 class="text-[11px] font-bold text-gray-400 uppercase tracking-[0.3em] leading-none mb-1.5">Gobierno Aut√≥nomo</h2>
                    <h1 class="text-2xl font-black text-gray-900 uppercase leading-none tracking-tight">Municipal de Oruro</h1>
                    <div class="flex items-center gap-2 mt-2">
                        <span class="px-2 py-0.5 bg-red-50 text-red-700 text-[10px] font-black uppercase rounded-md tracking-widest">Tr√°fico y Vialidad</span>
                        <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                        <span id="fecha-actual" class="text-[11px] font-medium text-gray-500 capitalize"></span>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 rounded-3xl border border-gray-100 text-right w-full md:w-auto">
                <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest block mb-1">ID de Sesi√≥n Digital</span>
                <span class="text-xs font-mono font-bold text-gray-700">GAMO-PRD-2024</span>
            </div>
        </div>

        <!-- Dashboard R√°pido -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
            <div class="stat-card">
                <span class="text-[10px] font-bold text-gray-400 uppercase mb-1">Total Hoy</span>
                <span id="stat-total" class="text-2xl font-black text-gray-800">0</span>
            </div>
            <div class="stat-card">
                <span class="text-[10px] font-bold text-gray-400 uppercase mb-1">Particulares</span>
                <span id="stat-particular" class="text-2xl font-black text-blue-600">0</span>
            </div>
            <div class="stat-card">
                <span class="text-[10px] font-bold text-gray-400 uppercase mb-1">P√∫blicos</span>
                <span id="stat-publico" class="text-2xl font-black text-red-600">0</span>
            </div>
            <div class="stat-card">
                <span class="text-[10px] font-bold text-gray-400 uppercase mb-1">Otros</span>
                <span id="stat-otros" class="text-2xl font-black text-gray-500">0</span>
            </div>
        </div>

        <!-- Formulario Principal -->
        <form id="infraccionForm" class="space-y-8">
            <input type="hidden" id="editId" value="">
            
            <!-- DATOS T√âCNICOS -->
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-8 space-y-6">
                    <div>
                        <h3 class="text-xs font-black text-red-700 uppercase mb-4 flex items-center gap-2">
                            <span class="w-2 h-2 bg-red-700 rounded-full"></span> Identificaci√≥n del Infractor
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="col-span-2">
                                <label class="label-style">N√∫mero de Placa</label>
                                <input type="text" id="placa" required class="w-full bg-gray-50 border-2 border-transparent focus:border-red-600 focus:bg-white rounded-2xl px-5 py-4 text-2xl uppercase font-black tracking-widest outline-none transition-all shadow-sm" placeholder="1234-ABC">
                            </div>
                            <div>
                                <label class="label-style">Tipo Veh√≠culo</label>
                                <select id="tipoVehiculo" class="input-field h-[64px] font-bold">
                                    <option value="Particular">Particular</option>
                                    <option value="Servicio P√∫blico">Servicio P√∫blico</option>
                                    <option value="Motocicleta">Motocicleta</option>
                                    <option value="Cami√≥n">Cami√≥n</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div>
                                <label class="label-style">Marca</label>
                                <input type="text" id="marca" class="input-field h-[64px]" placeholder="Ej. Toyota">
                            </div>
                            <div class="col-span-2">
                                <label class="label-style">Nombre del Conductor</label>
                                <input type="text" id="nombreConductor" class="input-field" placeholder="Nombre completo">
                            </div>
                            <div>
                                <label class="label-style">CI / Documento</label>
                                <input type="text" id="licencia" class="input-field" placeholder="Nro de CI">
                            </div>
                            <div>
                                <label class="label-style">Color</label>
                                <input type="text" id="color" class="input-field" placeholder="Ej. Rojo">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xs font-black text-red-700 uppercase mb-4 flex items-center gap-2">
                            <span class="w-2 h-2 bg-red-700 rounded-full"></span> Localizaci√≥n y Motivo
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="col-span-1">
                                <label class="label-style">Infracci√≥n Cometida</label>
                                <input type="text" id="tipoInfraccion" required class="input-field font-semibold" placeholder="Ej. Estacionamiento prohibido">
                            </div>
                            <div class="col-span-1">
                                <label class="label-style">Ubicaci√≥n Exacta</label>
                                <input type="text" id="lugar" required class="input-field" placeholder="Calle/Avenida">
                            </div>
                            <div>
                                <label class="label-style">Fecha</label>
                                <input type="date" id="fecha" required class="input-field">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="label-style">Hora</label>
                                    <input type="time" id="hora" required class="input-field">
                                </div>
                                <div>
                                    <label class="label-style">Oficial</label>
                                    <input type="text" id="funcionario" required class="input-field font-bold text-red-800" placeholder="Nombre">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EVIDENCIA LATERAL -->
                <div class="lg:col-span-4 space-y-4">
                    <label class="label-style text-center">Evidencia Visual</label>
                    <label for="fotoInput" class="block w-full cursor-pointer bg-gray-50 border-2 border-dashed border-gray-200 rounded-3xl p-8 text-center hover:bg-red-50 hover:border-red-200 transition-all group relative overflow-hidden h-[280px] flex flex-col items-center justify-center">
                        <div id="imagePreview" class="absolute inset-0 hidden"></div>
                        <div class="relative z-10 group-hover:scale-110 transition-transform duration-500">
                            <div class="text-4xl mb-3">üì∏</div>
                            <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Capturar Foto</p>
                        </div>
                        <input type="file" id="fotoInput" accept="image/*" class="hidden">
                    </label>
                    <input type="hidden" id="fotoBase64">
                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                        <p class="text-[10px] text-blue-700 font-bold leading-relaxed">
                            ‚ö†Ô∏è Aseg√∫rese de que la placa sea legible en la fotograf√≠a para el respaldo legal.
                        </p>
                    </div>
                </div>
            </div>

            <div>
                <label class="label-style">Observaciones Adicionales</label>
                <textarea id="observaciones" rows="2" class="input-field resize-none" placeholder="Escriba detalles relevantes observados en el lugar..."></textarea>
            </div>

            <!-- Acciones -->
            <div class="flex flex-col sm:flex-row gap-4 pt-6">
                <button type="submit" id="btnGuardar" class="flex-[2] bg-red-700 hover:bg-red-800 text-white font-black py-5 rounded-2xl shadow-2xl shadow-red-200 uppercase tracking-[0.2em] text-xs transition-all active:scale-95 flex items-center justify-center gap-3">
                    <span id="btnIcon">üíæ</span> <span id="btnText">Confirmar Registro</span>
                </button>
                <button type="button" onclick="window.resetForm()" class="flex-1 px-8 py-5 bg-gray-100 text-gray-500 font-bold rounded-2xl text-[10px] uppercase hover:bg-gray-200 transition-all">
                    Cancelar / Nuevo
                </button>
            </div>
        </form>

        <!-- Historial Din√°mico -->
        <div class="mt-20 pt-10 border-t border-gray-100">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div>
                    <h3 class="text-2xl font-black text-gray-900 tracking-tight">Base de Datos</h3>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-[0.2em]">Registros en tiempo real</p>
                </div>
                
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <div class="relative flex-1 md:w-64">
                        <input type="text" id="searchInput" oninput="window.renderTabla()" placeholder="Buscar placa..." class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2.5 text-xs outline-none focus:border-red-300">
                        <span class="absolute right-3 top-2.5 opacity-30">üîç</span>
                    </div>
                    <button onclick="window.exportarReporteGeneral()" class="bg-gray-900 text-white text-[9px] font-black uppercase tracking-widest px-6 py-3.5 rounded-xl hover:bg-black transition-all shadow-xl flex items-center gap-2">
                        <span>üìä</span> Reporte
                    </button>
                </div>
            </div>

            <div class="overflow-hidden bg-white border border-gray-100 rounded-3xl shadow-xl">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 border-b border-gray-100">
                        <tr>
                            <th class="p-4 text-[10px] font-black text-gray-400 uppercase tracking-widest">Informaci√≥n</th>
                            <th class="p-4 text-[10px] font-black text-gray-400 uppercase tracking-widest hidden md:table-cell">Infracci√≥n</th>
                            <th class="p-4 text-[10px] font-black text-gray-400 uppercase tracking-widest text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaRegistros" class="divide-y divide-gray-50">
                        <!-- Generado por JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-10 py-5 rounded-full shadow-2xl hidden z-[200] font-black text-[11px] transition-all text-center uppercase tracking-widest"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gamo-oficial-v1';

        let user = null;
        let registrosLocales = [];

        // Inicializar UI
        document.getElementById('fecha-actual').innerText = new Date().toLocaleDateString('es-BO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                const indicator = document.getElementById('sync-indicator');
                indicator.innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full"></span> SISTEMA EN L√çNEA`;
                indicator.className = "bg-green-50 text-green-600 border border-green-200 uppercase";
                initDataListener();
            }
        });

        function initDataListener() {
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'infracciones');
            onSnapshot(colRef, (snapshot) => {
                registrosLocales = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                registrosLocales.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                updateStats();
                renderTabla();
            }, (err) => showToast("Error de conexi√≥n"));
        }

        function updateStats() {
            document.getElementById('stat-total').innerText = registrosLocales.length;
            document.getElementById('stat-particular').innerText = registrosLocales.filter(r => r.tipoVehiculo === 'Particular').length;
            document.getElementById('stat-publico').innerText = registrosLocales.filter(r => r.tipoVehiculo === 'Servicio P√∫blico').length;
            document.getElementById('stat-otros').innerText = registrosLocales.filter(r => !['Particular', 'Servicio P√∫blico'].includes(r.tipoVehiculo)).length;
        }

        window.renderTabla = () => {
            const tbody = document.getElementById('tablaRegistros');
            const search = document.getElementById('searchInput').value.toUpperCase();
            
            let html = '';
            const filtered = registrosLocales.filter(r => r.placa.includes(search));

            filtered.forEach((reg) => {
                html += `
                    <tr class="hover:bg-gray-50 transition-colors group">
                        <td class="p-4">
                            <div class="flex items-center gap-4">
                                <div class="relative">
                                    ${reg.foto ? `<img src="${reg.foto}" class="w-14 h-14 object-cover rounded-2xl shadow-lg border-2 border-white ring-1 ring-gray-100">` : 
                                    '<div class="w-14 h-14 bg-gray-100 rounded-2xl flex items-center justify-center text-[9px] text-gray-400 font-black uppercase">S/F</div>'}
                                </div>
                                <div>
                                    <div class="text-[14px] font-black text-gray-900 tracking-tight">${reg.placa}</div>
                                    <div class="text-[10px] text-gray-400 font-bold uppercase tracking-tight">${reg.nombreConductor || 'CONDUCCI√ìN AN√ìNIMA'}</div>
                                    <div class="text-[9px] bg-gray-100 px-1.5 py-0.5 rounded text-gray-500 inline-block mt-1 font-bold italic">${reg.fecha}</div>
                                </div>
                            </div>
                        </td>
                        <td class="p-4 hidden md:table-cell">
                            <div class="text-[11px] font-bold text-gray-700">${reg.infraccion}</div>
                            <div class="text-[9px] text-gray-400 truncate max-w-[200px]">${reg.lugar}</div>
                        </td>
                        <td class="p-4 text-right">
                            <div class="flex justify-end items-center gap-2">
                                <button onclick="window.descargarBoletaPDF('${reg.id}')" class="w-9 h-9 flex items-center justify-center bg-gray-50 text-gray-400 rounded-xl hover:bg-red-700 hover:text-white hover:shadow-lg transition-all" title="Ver Boleta">üìÑ</button>
                                <button onclick="window.editRegistro('${reg.id}')" class="w-9 h-9 flex items-center justify-center bg-gray-50 text-gray-400 rounded-xl hover:bg-blue-600 hover:text-white hover:shadow-lg transition-all" title="Editar">‚úèÔ∏è</button>
                                <button onclick="window.deleteRegistro('${reg.id}')" class="w-9 h-9 flex items-center justify-center bg-gray-50 text-gray-400 rounded-xl hover:bg-red-600 hover:text-white hover:shadow-lg transition-all" title="Borrar">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html || '<tr><td colspan="3" class="p-12 text-center text-gray-400 font-bold uppercase text-[10px] tracking-widest">Sin registros que coincidan</td></tr>';
        };

        const fotoInput = document.getElementById('fotoInput');
        fotoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_SIZE = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } 
                    else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }

                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    const base64 = canvas.toDataURL('image/jpeg', 0.6);
                    document.getElementById('fotoBase64').value = base64;
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `<img src="${base64}" class="w-full h-full object-cover">`;
                    preview.classList.remove('hidden');
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('infraccionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!user) return;
            const btn = document.getElementById('btnGuardar');
            const txt = document.getElementById('btnText');
            btn.disabled = true;
            txt.innerText = "PROCESANDO REGISTRO...";
            
            const data = {
                placa: document.getElementById('placa').value.toUpperCase().trim(),
                nombreConductor: document.getElementById('nombreConductor').value,
                tipoVehiculo: document.getElementById('tipoVehiculo').value,
                marca: document.getElementById('marca').value,
                color: document.getElementById('color').value,
                licencia: document.getElementById('licencia').value,
                foto: document.getElementById('fotoBase64').value || "",
                infraccion: document.getElementById('tipoInfraccion').value,
                observaciones: document.getElementById('observaciones').value,
                hora: document.getElementById('hora').value,
                fecha: document.getElementById('fecha').value,
                lugar: document.getElementById('lugar').value,
                funcionario: document.getElementById('funcionario').value,
                timestamp: Date.now()
            };

            const editId = document.getElementById('editId').value;
            try {
                if (editId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'infracciones', editId), data);
                    showToast("MODIFICACI√ìN GUARDADA");
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'infracciones'), data);
                    showToast("REGISTRO EXITOSO");
                }
                window.resetForm();
            } catch (err) { showToast("ERROR DE RED"); }
            btn.disabled = false;
            txt.innerText = "Confirmar Registro";
        });

        window.descargarBoletaPDF = (id) => {
            const reg = registrosLocales.find(x => x.id === id);
            if (!reg) return;
            const pw = window.open('', '_blank');
            pw.document.write(`
                <html>
                <head>
                    <title>GAMO_BOLETA_${reg.placa}</title>
                    <style>
                        body { font-family: 'Helvetica', sans-serif; padding: 40px; color: #1a1a1a; max-width: 700px; margin: auto; line-height: 1.5; }
                        .header { border-bottom: 5px solid #b91c1c; padding-bottom: 20px; text-align: center; margin-bottom: 30px; }
                        .logo { font-size: 28px; font-weight: 900; color: #b91c1c; letter-spacing: -1px; }
                        .ticket-no { font-size: 10px; color: #888; font-weight: bold; margin-top: 5px; }
                        .placa-box { font-size: 50px; font-weight: 900; text-align: center; margin: 30px 0; border: 4px solid #000; padding: 10px 40px; background: #fff; letter-spacing: 5px; }
                        .section { background: #f8f8f8; padding: 25px; border-radius: 20px; margin-bottom: 20px; }
                        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
                        .label { font-size: 10px; font-weight: 900; color: #b91c1c; text-transform: uppercase; margin-bottom: 3px; }
                        .value { font-size: 15px; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 2px; }
                        .foto-container { margin-top: 30px; text-align: center; }
                        .foto-container img { max-width: 100%; border-radius: 15px; border: 1px solid #ddd; }
                        .footer { margin-top: 40px; text-align: center; font-size: 10px; color: #888; border-top: 1px dashed #ccc; padding-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="logo">GOBIERNO AUT√ìNOMO MUNICIPAL DE ORURO</div>
                        <div style="font-weight:bold; color: #444; margin-top:5px">DIRECCI√ìN DE TR√ÅFICO Y VIALIDAD</div>
                        <div class="ticket-no">BOLETA ELECTR√ìNICA DE INFRACCI√ìN #${id.substring(0,8).toUpperCase()}</div>
                    </div>
                    <div style="text-align:center"><div class="placa-box">${reg.placa}</div></div>
                    <div class="section">
                        <div class="grid">
                            <div><div class="label">Conductor</div><div class="value">${reg.nombreConductor || 'AN√ìNIMO'}</div></div>
                            <div><div class="label">Documento/CI</div><div class="value">${reg.licencia || 'NO REGISTRADO'}</div></div>
                            <div><div class="label">Clase de Veh√≠culo</div><div class="value">${reg.tipoVehiculo}</div></div>
                            <div><div class="label">Color / Marca</div><div class="value">${reg.color} - ${reg.marca}</div></div>
                        </div>
                    </div>
                    <div class="section">
                        <div class="label">Causa de Infracci√≥n</div><div class="value" style="font-size: 18px">${reg.infraccion}</div>
                        <div style="margin-top:15px"><div class="label">Lugar de los Hechos</div><div class="value">${reg.lugar}</div></div>
                        <div class="grid" style="margin-top:15px">
                            <div><div class="label">Fecha y Hora</div><div class="value">${reg.fecha} | ${reg.hora}</div></div>
                            <div><div class="label">Oficial Operante</div><div class="value">${reg.funcionario}</div></div>
                        </div>
                    </div>
                    ${reg.foto ? `<div class="foto-container"><div class="label">Evidencia de Campo</div><img src="${reg.foto}"></div>` : ''}
                    <div class="footer">ESTA BOLETA TIENE VALIDEZ LEGAL Y EST√Å REGISTRADA EN EL SISTEMA CENTRAL DEL GAMO</div>
                    <script>window.onload=function(){setTimeout(()=> {window.print(); window.close();}, 500);}<\/script>
                </body>
                </html>
            `);
            pw.document.close();
        };

        window.exportarReporteGeneral = () => {
            if (registrosLocales.length === 0) return showToast("Sin datos");
            const win = window.open('', '_blank');
            const rows = registrosLocales.map(r => `
                <tr>
                    <td style="text-align:center">${r.foto ? `<img src="${r.foto}" style="height:40px;width:60px;object-fit:cover;border-radius:4px">` : 'N/A'}</td>
                    <td style="font-weight:bold; font-size: 12px">${r.placa}</td>
                    <td>${r.nombreConductor || 'S/N'}<br><small>${r.tipoVehiculo}</small></td>
                    <td>${r.infraccion}</td>
                    <td>${r.lugar}<br><small>${r.fecha} ${r.hora}</small></td>
                    <td style="font-weight:bold; color:#b91c1c">${r.funcionario}</td>
                </tr>
            `).join('');

            win.document.write(`
                <html>
                <head><title>Reporte_GAMO</title><style>
                    body { font-family: sans-serif; padding: 40px; }
                    h1 { color: #b91c1c; text-align: center; font-size: 24px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 30px; }
                    th { background: #f4f4f4; border: 1px solid #ddd; padding: 12px; font-size: 10px; text-transform: uppercase; }
                    td { border: 1px solid #ddd; padding: 10px; font-size: 11px; }
                </style></head>
                <body>
                    <h1>REPORTE CONSOLIDADO DE INFRACCIONES - GAMO</h1>
                    <p style="text-align:center; font-size:10px">GENERADO EL: ${new Date().toLocaleString()}</p>
                    <table>
                        <thead><tr><th>EVIDENCIA</th><th>PLACA</th><th>CONDUCTOR</th><th>MOTIVO</th><th>FECHA/LUGAR</th><th>OFICIAL</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                    <script>window.onload=function(){window.print();}<\/script>
                </body></html>
            `);
            win.document.close();
        };

        window.editRegistro = (id) => {
            const r = registrosLocales.find(x => x.id === id);
            if (!r) return;
            document.getElementById('editId').value = id;
            document.getElementById('placa').value = r.placa;
            document.getElementById('nombreConductor').value = r.nombreConductor || "";
            document.getElementById('tipoVehiculo').value = r.tipoVehiculo;
            document.getElementById('marca').value = r.marca || "";
            document.getElementById('color').value = r.color || "";
            document.getElementById('licencia').value = r.licencia || "";
            document.getElementById('tipoInfraccion').value = r.infraccion;
            document.getElementById('observaciones').value = r.observaciones || "";
            document.getElementById('hora').value = r.hora;
            document.getElementById('fecha').value = r.fecha;
            document.getElementById('lugar').value = r.lugar;
            document.getElementById('funcionario').value = r.funcionario;
            document.getElementById('fotoBase64').value = r.foto || "";
            if (r.foto) {
                const p = document.getElementById('imagePreview');
                p.innerHTML = `<img src="${r.foto}" class="w-full h-full object-cover rounded-2xl">`;
                p.classList.remove('hidden');
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showToast("MODO EDICI√ìN ACTIVADO");
        };

        window.deleteRegistro = async (id) => {
            if (confirm("¬øConfirmar eliminaci√≥n definitiva del registro?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'infracciones', id));
                showToast("REGISTRO BORRADO");
            }
        };

        window.resetForm = () => {
            document.getElementById('infraccionForm').reset();
            document.getElementById('editId').value = "";
            document.getElementById('fotoBase64').value = "";
            document.getElementById('imagePreview').classList.add('hidden');
            const now = new Date();
            document.getElementById('fecha').valueAsDate = now;
            document.getElementById('hora').value = now.toTimeString().substring(0,5);
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        window.resetForm();
    </script>
</body>
</html>